stages:
  - lint
  - build_docs
  - deploy
  - test

before_script:
  - make venv

ruff:
  stage: lint
  image: "python:$VERSION"
  parallel:
    matrix:
      - VERSION: ["3.9", "3.10", "3.11", "3.12", "3.13"]
  script:
    - uv run ruff check .
    - uv run ruff format .
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - tests/**/*
        - prettier_maps/**/*
        - .gitlab/**/*

mypy:
  stage: lint
  image: "python:$VERSION"
  parallel:
    matrix:
      - VERSION: ["3.9", "3.10", "3.11", "3.12", "3.13"]
  script:
    - uv run mypy .
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - tests/**/*
        - prettier_maps/**/*
        - .gitlab/**/*

test:
  stage: test
  image: "python:$VERSION"
  parallel:
    matrix:
      - VERSION: ["3.9", "3.10", "3.11", "3.12", "3.13"]
  script:
    - uv run pytest
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - tests/**/*
        - prettier_maps/**/*
        - .gitlab/**/*

build_docs:
  stage: build_docs
  image: python:3.12
  script:
    - make docs
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - docs/**/*
